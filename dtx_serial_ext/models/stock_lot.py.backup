# -*- coding: utf-8 -*-
from odoo import models, fields, api


class StockLot(models.Model):
    _inherit = 'stock.lot'

    # ==========================================
    # DTX INTERNAL SERIAL
    # ==========================================
    dtx_serial_internal = fields.Char(
        string='DTX Internal Serial',
        index=True,
        help='Optional DTX internal serial number for customer-facing identification',
    )

    # ==========================================
    # DEVICE LIFECYCLE STATE
    # ==========================================
    lifecycle_state = fields.Selection(
        selection=[
            ('stock', 'In Stock'),
            ('allocated', 'Allocated to Project'),
            ('delivered', 'Delivered'),
            ('installed', 'Installed'),
            ('maintenance', 'Under Maintenance'),
            ('scrapped', 'Scrapped'),
        ],
        string='Lifecycle State',
        default='stock',
        required=True,
        tracking=True,
        help='Current lifecycle status of the device',
    )

    # ==========================================
    # PROJECT & CUSTOMER REFERENCES
    # ==========================================
    # Note: project_id will be added when dtx_ops_project module is installed
    # Using related field for now to avoid dependency
    customer_id = fields.Many2one(
        'res.partner',
        string='Customer',
        tracking=True,
        help='Final customer who owns this device',
    )

    # ==========================================
    # VENDOR INVOICE TRACKING
    # ==========================================
    vendor_invoice_state = fields.Selection(
        selection=[
            ('missing', 'Invoice Missing'),
            ('linked', 'Invoice Linked'),
            ('replaced', 'Invoice Replaced'),
        ],
        string='Vendor Invoice State',
        default='missing',
        required=True,
        tracking=True,
        help='Tracks whether vendor invoice exists for this device',
    )

    vendor_invoice_ref = fields.Char(
        string='Vendor Invoice Reference',
        tracking=True,
        help='Vendor invoice number/reference',
    )

    vendor_invoice_date = fields.Date(
        string='Vendor Invoice Date',
        tracking=True,
    )

    vendor_invoice_note = fields.Text(
        string='Vendor Invoice Notes',
        help='Notes about invoice replacement, corrections, etc.',
    )

    # ==========================================
    # CUSTOMER INVOICE TRACKING (SALES)
    # ==========================================
    customer_invoice_ref = fields.Char(
        string='Customer Invoice Reference',
        tracking=True,
        help='Sales invoice number for customer (hóa đơn xuất cho khách)',
    )

    customer_invoice_date = fields.Date(
        string='Customer Invoice Date',
        tracking=True,
    )

    customer_invoice_note = fields.Text(
        string='Customer Invoice Notes',
        help='Notes about customer invoice',
    )

    # ==========================================
    # WARRANTY TRACKING
    # ==========================================
    warranty_start = fields.Date(
        string='Warranty Start Date',
        help='Supplier warranty start date',
    )

    warranty_end = fields.Date(
        string='Warranty End Date',
        help='Supplier warranty expiration date',
    )

    warranty_active = fields.Boolean(
        string='Warranty Active',
        compute='_compute_warranty_active',
        store=True,
        help='Indicates if warranty is currently active',
    )

    # ==========================================
    # GOOGLE DRIVE LINK
    # ==========================================
    gdrive_link = fields.Char(
        string='Google Drive Link',
        help='Link to device documentation in Google Drive',
    )

    # ==========================================
    # COMPUTED FIELDS
    # ==========================================
    @api.depends('warranty_start', 'warranty_end')
    def _compute_warranty_active(self):
        """Check if warranty is currently active based on dates"""
        today = fields.Date.today()
        for lot in self:
            if lot.warranty_start and lot.warranty_end:
                lot.warranty_active = lot.warranty_start <= today <= lot.warranty_end
            else:
                lot.warranty_active = False

    # ==========================================
    # ONCHANGE METHODS
    # ==========================================
    @api.onchange('vendor_invoice_ref')
    def _onchange_vendor_invoice_ref(self):
        """Auto-update vendor_invoice_state when reference is entered"""
        for lot in self:
            if lot.vendor_invoice_ref and lot.vendor_invoice_state == 'missing':
                lot.vendor_invoice_state = 'linked'
            elif not lot.vendor_invoice_ref and lot.vendor_invoice_state == 'linked':
                lot.vendor_invoice_state = 'missing'

    # ==========================================
    # SEARCH METHODS
    # ==========================================
    @api.model
    def _name_search(self, name='', args=None, operator='ilike', limit=100, name_get_uid=None):
        """
        Enhanced search to allow searching by both supplier serial (name)
        and DTX internal serial
        """
        args = args or []
        domain = []

        if name:
            domain = [
                '|',
                ('name', operator, name),
                ('dtx_serial_internal', operator, name),
            ]

        return self._search(domain + args, limit=limit, access_rights_uid=name_get_uid)

    # ==========================================
    # DISPLAY NAME
    # ==========================================
    def name_get(self):
        """
        Enhanced display name showing both serials if DTX internal exists
        Format: "SUPPLIER_SERIAL [DTX_SERIAL]" or just "SUPPLIER_SERIAL"
        """
        result = []
        for lot in self:
            if lot.dtx_serial_internal:
                name = f"{lot.name} [{lot.dtx_serial_internal}]"
            else:
                name = lot.name
            result.append((lot.id, name))
        return result
