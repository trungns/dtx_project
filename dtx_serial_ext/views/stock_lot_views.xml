<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ==========================================
         STOCK LOT / SERIAL NUMBER - TREE VIEW
         ========================================== -->
    <record id="view_stock_lot_tree_dtx" model="ir.ui.view">
        <field name="name">stock.lot.tree.dtx</field>
        <field name="model">stock.lot</field>
        <field name="inherit_id" ref="stock.view_production_lot_tree"/>
        <field name="arch" type="xml">
            <!-- Add DTX fields to tree view -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="dtx_serial_internal"/>
                <field name="lifecycle_state" widget="badge"
                       decoration-success="lifecycle_state in ('stock', 'installed')"
                       decoration-info="lifecycle_state == 'allocated'"
                       decoration-warning="lifecycle_state == 'maintenance'"
                       decoration-danger="lifecycle_state == 'scrapped'"/>
                <field name="vendor_invoice_state" widget="badge"
                       decoration-danger="vendor_invoice_state == 'missing'"
                       decoration-success="vendor_invoice_state == 'linked'"
                       decoration-warning="vendor_invoice_state == 'replaced'"/>
                <field name="purchase_order_ids" widget="many2many_tags" optional="show"/>
                <field name="sale_order_ids" widget="many2many_tags" optional="show"/>
                <field name="customer_id" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- ==========================================
         STOCK LOT / SERIAL NUMBER - FORM VIEW
         ========================================== -->
    <record id="view_stock_lot_form_dtx" model="ir.ui.view">
        <field name="name">stock.lot.form.dtx</field>
        <field name="model">stock.lot</field>
        <field name="inherit_id" ref="stock.view_production_lot_form"/>
        <field name="arch" type="xml">
            <!-- Add status bar -->
            <xpath expr="//sheet" position="before">
                <header>
                    <field name="lifecycle_state" widget="statusbar"
                           statusbar_visible="stock,allocated,delivered,installed"/>
                </header>
            </xpath>

            <!-- Restructure form for mobile-friendly layout -->
            <xpath expr="//group[@name='main_group']" position="replace">
                <group name="main_group">
                    <!-- Left column: Serial Numbers & Basic Info -->
                    <group name="serial_info" string="Serial Numbers">
                        <field name="name" readonly="1"/>
                        <field name="dtx_serial_internal" placeholder="Optional DTX internal serial"/>
                        <field name="product_id" readonly="1"/>
                        <field name="company_id" groups="base.group_multi_company" readonly="1"/>
                    </group>

                    <!-- Right column: Lifecycle & References -->
                    <group name="lifecycle_info" string="Lifecycle &amp; References">
                        <field name="lifecycle_state" widget="badge"
                               decoration-success="lifecycle_state in ('stock', 'installed')"
                               decoration-info="lifecycle_state == 'allocated'"
                               decoration-warning="lifecycle_state == 'maintenance'"
                               decoration-danger="lifecycle_state == 'scrapped'"/>
                        <field name="customer_id" options="{'no_create': True}"/>
                        <!-- project_id will be added by dtx_ops_project module -->
                    </group>
                </group>

                <!-- Purchase Order & Vendor Invoice Tracking -->
                <group name="vendor_invoice_group" string="Purchase Order &amp; Vendor Invoice">
                    <group name="vendor_invoice_left">
                        <field name="purchase_order_ids" widget="many2many_tags"
                               options="{'color_field': 'state', 'no_create': True}"/>
                        <field name="vendor_bill_ids" widget="many2many_tags"
                               options="{'color_field': 'state', 'no_create': True}"/>
                        <field name="vendor_invoice_state" widget="selection"
                               decoration-danger="vendor_invoice_state == 'missing'"
                               decoration-success="vendor_invoice_state == 'linked'"
                               decoration-warning="vendor_invoice_state == 'replaced'"
                               readonly="0"/>
                    </group>
                    <group name="vendor_invoice_right">
                        <field name="vendor_invoice_note" placeholder="Notes about invoice replacement, corrections, etc."/>
                    </group>
                </group>

                <!-- Sales Order & Customer Invoice Tracking -->
                <group name="customer_invoice_group" string="Sales Order &amp; Customer Invoice">
                    <group name="customer_invoice_left">
                        <field name="sale_order_ids" widget="many2many_tags"
                               options="{'color_field': 'state', 'no_create': True}"/>
                        <field name="customer_invoice_ids" widget="many2many_tags"
                               options="{'color_field': 'state', 'no_create': True}"/>
                    </group>
                    <group name="customer_invoice_right">
                        <field name="customer_invoice_note" placeholder="Notes about customer invoice..."/>
                    </group>
                </group>

                <!-- Warranty Information -->
                <group name="warranty_group" string="Warranty Information">
                    <group name="warranty_left">
                        <field name="warranty_start"/>
                        <field name="warranty_end"/>
                    </group>
                    <group name="warranty_right">
                        <field name="warranty_active" widget="boolean_toggle" readonly="1"/>
                    </group>
                </group>

                <!-- Documentation -->
                <group name="documentation_group" string="Documentation">
                    <field name="gdrive_link" widget="url" placeholder="https://drive.google.com/..."/>
                    <field name="note" placeholder="Internal notes about this device..."/>
                </group>
            </xpath>

            <!-- Keep existing notebook tabs (stock moves, etc.) -->
        </field>
    </record>

    <!-- ==========================================
         STOCK LOT / SERIAL NUMBER - SEARCH VIEW
         ========================================== -->
    <record id="view_stock_lot_search_dtx" model="ir.ui.view">
        <field name="name">stock.lot.search.dtx</field>
        <field name="model">stock.lot</field>
        <field name="inherit_id" ref="stock.search_product_lot_filter"/>
        <field name="arch" type="xml">
            <!-- Add search fields -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="dtx_serial_internal" string="DTX Serial"
                       filter_domain="[('dtx_serial_internal', 'ilike', self)]"/>
                <field name="customer_id" string="Customer"/>
                <field name="purchase_order_ids" string="Purchase Order"/>
                <field name="sale_order_ids" string="Sales Order"/>
            </xpath>

            <!-- Add filters -->
            <xpath expr="//search" position="inside">
                <separator/>
                <filter string="In Stock" name="filter_in_stock"
                        domain="[('lifecycle_state', '=', 'stock')]"/>
                <filter string="Allocated" name="filter_allocated"
                        domain="[('lifecycle_state', '=', 'allocated')]"/>
                <filter string="Delivered" name="filter_delivered"
                        domain="[('lifecycle_state', '=', 'delivered')]"/>
                <filter string="Installed" name="filter_installed"
                        domain="[('lifecycle_state', '=', 'installed')]"/>
                <filter string="Maintenance" name="filter_maintenance"
                        domain="[('lifecycle_state', '=', 'maintenance')]"/>
                <separator/>
                <filter string="Invoice Missing" name="filter_invoice_missing"
                        domain="[('vendor_invoice_state', '=', 'missing')]"/>
                <filter string="Invoice Linked" name="filter_invoice_linked"
                        domain="[('vendor_invoice_state', '=', 'linked')]"/>
                <separator/>
                <filter string="Warranty Active" name="filter_warranty_active"
                        domain="[('warranty_active', '=', True)]"/>

                <!-- Add group by -->
                <group expand="0" string="Group By">
                    <filter string="Lifecycle State" name="group_lifecycle_state"
                            context="{'group_by': 'lifecycle_state'}"/>
                    <filter string="Vendor Invoice State" name="group_vendor_invoice_state"
                            context="{'group_by': 'vendor_invoice_state'}"/>
                    <filter string="Customer" name="group_customer"
                            context="{'group_by': 'customer_id'}"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- ==========================================
         MENU: QUICK ACCESS TO SERIALS
         ========================================== -->
    <record id="action_stock_lot_dtx" model="ir.actions.act_window">
        <field name="name">Device Serials</field>
        <field name="res_model">stock.lot</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{
            'search_default_product': 1,
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No serial numbers found
            </p>
            <p>
                Serial numbers are created when receiving devices with serial tracking enabled.
            </p>
        </field>
    </record>

    <!-- Add menu item under Inventory > Products -->
    <menuitem id="menu_stock_lot_dtx"
              name="Device Serials"
              parent="stock.menu_stock_inventory_control"
              action="action_stock_lot_dtx"
              sequence="10"/>

</odoo>
